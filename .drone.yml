clone:
  git:
    image: plugins/git:next
workspace:
  base: /test
  path: downstream
services:
  web:
    image: fpfis/php71-build
    environment:
      - TOOLKIT_ENV_PROPS=/test/downstream/vendor/ec-europa/toolkit/includes/phing/props/drone.props
matrix:
  REPOSITORY:
    - ec-europa/euetfa-reference
    - ec-europa/europaeu-reference
    # - ec-europa/ewrc-reference
    # - ec-europa/horizon2020-reference
    # - ec-europa/maritimeforum-reference
    # - ec-europa/stages2-reference
    # - ec-europa/srb-reference
    # - ec-europa/eu-aid-reference
    # - ec-europa/kci-reference
    # - ec-europa/farnet-reference
    # - ec-europa/digital-agenda-reference
    # - ec-europa/health-reference
    # - ec-europa/dms-reference
    # - ec-europa/euandme-reference
    # - ec-europa/amr-reference
    # - ec-europa/crosportal-reference
    # - ec-europa/primeinfrastructure-reference
    # - ec-europa/edpsweb-reference
    # - ec-europa/oil-mit-reference
    # - ec-europa/food-animals-plants-reference
    # - ec-europa/esf-tc-reference
    # - ec-europa/erasmusplus2-reference
    # - ec-europa/sport-reference
    # - ec-europa/easme-site-reference
    # - ec-europa/eych-reference
    # - ec-europa/eiopa-reference
    # - ec-europa/microdata-reference
    # - ec-europa/taxud-reference
    # - ec-europa/comm-digitaltransformation-blog-reference
    # - ec-europa/expert-pane-reference
    # - ec-europa/anti-fraud-reference
    # - ec-europa/education2-reference
    # - ec-europa/epale-reference
    # - ec-europa/edpb-reference
    # - ec-europa/epsc-reference
    # - ec-europa/eu-aid-explorer-reference
    # - ec-europa/echo-site-reference
    # - ec-europa/argiculture-reference
    # - ec-europa/creativeeurope-reference
    # - ec-europa/safety_alerts-reference
    # - ec-europa/mossportal-reference
    # - ec-europa/road-safety-reference
    # - ec-europa/encasia-reference
    # - ec-europa/eusinglesky-reference
    # - ec-europa/euprotects-reference
    # - ec-europa/eusdgs-reference
    # - ec-europa/cem-reference
    # - ec-europa/commpo-reference
    # - ec-europa/publicare-reference
    # - ec-europa/inseparable-reference
    # - ec-europa/mare-emd-reference
    # - ec-europa/mare-magaz-reference
    # - ec-europa/eurydice-reference
    # - ec-europa/youthwiki-reference
    # - ec-europa/basext-reference
    # - ec-europa/jrccties-reference
pipeline:
  composer:
    image: fpfis/php71-build
    secrets: [ github_api_token ]
    commands:
      - rm -rf /cache/*
      - mkdir -p repositories/${REPOSITORY}
      - export CHECKSUM=$(md5sum composer.lock | cut -d ' ' -f 1)
      - tar -xzf /cache/composer/$${CHECKSUM}.tar.gz || composer install --ansi --no-suggest && tar -czf /cache/composer/$${CHECKSUM}.tar.gz ./vendor/
      - export CHECKSUM=$(git ls-remote https://$${GITHUB_API_TOKEN}@github.com/${REPOSITORY} master | cut -c1-8)
      - tar -xzf /cache/${REPOSITORY}/$${CHECKSUM}.tar.gz -C ./repositories/${REPOSITORY} || git clone --depth 1 https://$${GITHUB_API_TOKEN}@github.com/${REPOSITORY}.git -b master repositories/${REPOSITORY} && mkdir -p /cache/${REPOSITORY} && tar -czf /cache/${REPOSITORY}/$${CHECKSUM}.tar.gz ./repositories/${REPOSITORY}/
    volumes:
      - /cache/${DRONE_REPO_NAME}:/cache
  phpcs:
    image: fpfis/php71-build
    secrets: [ github_api_token ]
    when:
      status: [ success, failure ]
    commands:
      - ./vendor/bin/run project:phpcs --ansi